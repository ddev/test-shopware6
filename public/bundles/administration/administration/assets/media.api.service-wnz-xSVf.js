import{a$ as u,b0 as m}from"./channel-DB_OaefQ.js";import{A as d}from"./api.service-C8jZavFF.js";class c{constructor({uploadTag:e,src:t,targetId:s,fileName:r,extension:i="dat",isPrivate:n=!1}){this.running=!1,this.src=t,this.uploadTag=e,this.targetId=s,this.fileName=r,this.extension=i,this.error=null,this.isPrivate=n}}const h={UPLOAD_ADDED:"media-upload-add",UPLOAD_FINISHED:"media-upload-finish",UPLOAD_FAILED:"media-upload-fail",UPLOAD_CANCELED:"media-upload-cancel"},{Criteria:f}=Shopware.Data;class A extends d{constructor(e,t,s="media"){super(e,t,s),this.name="mediaService",this.uploads=[],this.$listeners={},this.cacheDefaultFolder={}}hasListeners(e){return e?this.$listeners.hasOwnProperty(e):!1}hasDefaultListeners(){return this.hasListeners("default")}addListener(e,t){this.hasListeners(e)||(this.$listeners[e]=[]),this.$listeners[e].push(t)}removeListener(e,t){if(this.hasListeners(e)){if(t===void 0){u.remove(this.$listeners[e],()=>!0);return}u.remove(this.$listeners[e],s=>s===t)}}removeDefaultListener(e){this.removeListener("default",e)}addDefaultListener(e){this.addListener("default",e)}getListenerForTag(e){const t=this.hasListeners(e)?this.$listeners[e]:[],s=this.hasDefaultListeners()?this.$listeners.default:[];return[...t,...s]}_createUploadEvent(e,t,s){return{action:e,uploadTag:t,payload:s}}addUpload(e,t){this.addUploads(e,[t])}addUploads(e,t){const s=t.map(r=>new c({uploadTag:e,...r}));this.uploads.push(...s),this.getListenerForTag(e).forEach(r=>{r(this._createUploadEvent(h.UPLOAD_ADDED,e,{data:s}))})}keepFile(e,t){const s=new c({uploadTag:e,...t});this.getListenerForTag(e).forEach(r=>{r(this._createUploadEvent(h.UPLOAD_FINISHED,e,{targetId:s.targetId,successAmount:0,failureAmount:0,totalAmount:0,customMessage:"global.sw-media-upload.notification.assigned.message"}))})}cancelUpload(e,t){const s=new c({uploadTag:e,...t});this.getListenerForTag(e).forEach(r=>{r(this._createUploadEvent(h.UPLOAD_CANCELED,e,{data:s}))})}removeByTag(e){u.remove(this.uploads,t=>t.uploadTag===e)}runUploads(e){const t=u.remove(this.uploads,a=>a.uploadTag===e),s=this.getListenerForTag(e);if(t.length===0)return Promise.resolve();const r=t.length;let i=0,n=0;return Promise.all(t.map(a=>a.running?Promise.resolve():(a.running=!0,this._startUpload(a).then(()=>{a.running=!1,i+=1,s.forEach(o=>{o(this._createUploadEvent(h.UPLOAD_FINISHED,e,{targetId:a.targetId,successAmount:i,failureAmount:n,totalAmount:r}))})}).catch(o=>{a.error=o,a.running=!1,n+=1,a.successAmount=i,a.failureAmount=n,a.totalAmount=r,s.forEach(l=>{l(this._createUploadEvent(h.UPLOAD_FAILED,e,a))})}))))}_startUpload(e){return e.src instanceof File?m.readAsArrayBuffer(e.src).then(t=>this.uploadMediaById(e.targetId,e.src.type,t,e.extension,e.fileName)):e.src instanceof URL?this.uploadMediaFromUrl(e.targetId,e.src.href,e.extension,e.fileName):Promise.reject(new Error("src of upload must either be an instance of File or URL"))}uploadMediaById(e,t,s,r,i=e){r==="glb"&&t===""&&(t="model/gltf-binary"),t==="application/json"&&(t="text/plain"),t===""&&(t="application/octet-stream");const n=`/_action/${this.getApiBasePath(e)}/upload`,a=this.getBasicHeaders({"Content-Type":t}),o={extension:r,fileName:i};return this.httpClient.post(n,s,{params:o,headers:a}).then(l=>d.handleResponse(l))}uploadMediaFromUrl(e,t,s,r=e){const i=`/_action/${this.getApiBasePath(e)}/upload`,n=this.getBasicHeaders({"Content-Type":"application/json"}),a={extension:s,fileName:r},o=JSON.stringify({url:t});return this.httpClient.post(i,o,{params:a,headers:n}).then(l=>d.handleResponse(l))}renameMedia(e,t){const s=`/_action/${this.getApiBasePath(e)}/rename`;return this.httpClient.post(s,JSON.stringify({fileName:t}),{params:{},headers:this.getBasicHeaders()}).then(r=>d.handleResponse(r))}provideName(e,t,s=null){const r=`/_action/${this.getApiBasePath()}/provide-name`;return this.httpClient.get(r,{params:{fileName:e,extension:t,mediaId:s},headers:this.getBasicHeaders()}).then(i=>d.handleResponse(i))}async getDefaultFolderId(e){var n;if(this.cacheDefaultFolder[e])return this.cacheDefaultFolder[e];const t=Shopware.Service("repositoryFactory").create("media_default_folder"),s=new f(1,1).addFilter(f.equals("entity",e)),r=await t.search(s);if(r.length!==1)return null;const i=r[0];return(n=i.folder)!=null&&n.id?(this.cacheDefaultFolder[e]=i.folder.id,i.folder.id):null}}export{h as UploadEvents,A as default};
